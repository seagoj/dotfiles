#!/bin/bash

root_branch=master

usage() {
	less <<USAGE_STR
usage: bf <command>

commands:
	ticket	Updates ${root_branch} from origin and creates new branch from ${root_branch} based on the ticket name
USAGE_STR
	exit 1
}

new_ticket() {
	if [[ $# != 1 ]]; then
		less "Must provide ticket id."
		exit 1
	fi

	root_branch=master
	ticket_id=$1

	git checkout ${root_branch} &&\
		git pull origin ${root_branch} &&\
		git checkout origin/${root_branch} -b $ticket_id
}

pr() {
	if [[ $# != 1 ]]; then
		less "Must provide commit hash."
		exit 1
	fi

	commit_hash=$1

	git checkout ${commit_branch} &&\
		git pull origin &&\
		git diff --name-only origin/${root_branch} ... ${commit_hash} &&\
		git diff -w origin/${root_branch} ... ${commit_hash}
}

prepare-deploy() {
	if [[ $# != 1 ]]; then
		less "Must provide commit hash or branch id."
		exit 1
	fi

	commit_hash=$1

	git checkout ${root_branch} &&\
		git pull origin ${root_branch} &&\
		git merge $commit_hash &&\
		git diff -w origin/${root_branch}
}

if [[ $# == 0 ]]; then
	usage
fi

while [[ $# > 0 ]]; do
	case $1 in
	start-ticket|ticket)
		new_ticket $2
		shift 2
		;;
	pr)
		pr $2
		shift 2
		;;
	prepare-deploy|pd)
		prepare-deploy $2
		shift 2
		;;
	*)
		usage
		;;
	esac
done
