#!/bin/sh
# vim: filetype=sh:

# shellcheck disable=SC1090
source "${XDG_FUNCTIONS_HOME}"/cli.sh
#/ Usage: v [arguments ...]
#/
#/ Arguments:
#/	--help			    Shows this
#/	--debug
#/	--destroy | --rebuild | -d  Destroys and rebuilds

cleanup() {
    EXIT_CODE=$?
    exit "${EXIT_CODE}"
}

v_arguments() {
    OUTPUT='&> /dev/null'

    while [ $# -gt 0 ]; do
	case "$1" in
	"--debug")
	    OUTPUT=""
	    ;;
	"--destroy" | "--rebuild" | "-d")
	    v_destroy && v_create_session
	    exit
	    ;;
	*)
	    echo "Unknown argument: $1"
	    exit 1
	    ;;
	esac
	shift
    done
}

v_connect() {
    v_resume_session || v_create_session
}

v_create_session() {
    log_info "no session to resume"
    log_info "recreating"
    ssh-keygen -R \[127.0.0.1\]:2222 && \
	vagrant up && \
	v_ssh
}

v_destroy() {
    log_info "destroying image"
    eval "vagrant destroy -f ${OUTPUT} && vagrant box remove bonfyre/vagrant --all"
}

v_resume_session() {
    log_info "attempting resume"
    eval "vagrant resume ${OUTPUT}"
    v_ssh
}

v_ssh() {
    if [[ -z "${VAGRANT_PROJECT_ROOT+x}" ]]; then
	vagrant ssh
    else
	vagrant ssh -c "cd ${VAGRANT_PROJECT_ROOT}; exec bash"
    fi
}

log_timestamp
v_arguments "$@"
v_connect
