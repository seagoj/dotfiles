#!/bin/sh

# shellcheck disable=SC1090
source "${XDG_FUNCTIONS_HOME}/cli.sh"

CONFIG_DIR=/Library/Preferences/SystemConfiguration
WIFI_PREFS_ARCHIVE="$HOME"/wifi-prefs

cleanup() {
    exit $?
}

reset_wifi_ensure_archive_dir() {
    if [[ ! -d "$WIFI_PREFS_ARCHIVE" ]]; then
        log_info "creating $WIFI_PREFS_ARCHIVE"
        mkdir -p "$WIFI_PREFS_ARCHIVE"
    fi
}

reset_wifi_mv_if_exists() {
    if [[ -f "$1" ]]; then
        sudo mv "$1" "$WIFI_PREFS_ARCHIVE/"
    fi
}

reset_wifi_archive() {
    log_info "archiving config"
    reset_wifi_mv_if_exists "$CONFIG_DIR/NetworkInterfaces.plist"
    reset_wifi_mv_if_exists "$CONFIG_DIR/com.apple.airport.preferences.plist"
    reset_wifi_mv_if_exists "$CONFIG_DIR/com.apple.wifi.message-tracer.plist"
    reset_wifi_mv_if_exists "$CONFIG_DIR/preferences.plist"
}

reset_wifi_reboot() {
    log_info "reboot"
    sudo reboot
}

reset_wifi_ensure_archive_dir
reset_wifi_archive

if [[ $# -gt 0 ]] && [[ "$1" == "--reboot" ]]; then
    reset_wifi_reboot
fi
